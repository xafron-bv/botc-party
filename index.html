<!DOCTYPE html>
<html lang="en-GB">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Blood on the Clocktower - Party Grimoire</title>
  <link rel="stylesheet" href="assets/fontawesome/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="assets/icons/android-chrome-192x192.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#583286">
</head>

<body>
  <script>
    // Apply theme immediately to prevent flash
    (function(){
      try {
        var theme = localStorage.getItem('selectedTheme') || 'blue';
        document.documentElement.setAttribute('data-theme', theme);
      } catch(_){ 
        document.documentElement.setAttribute('data-theme', 'blue');
      }
    })();
    // Apply character panel state
    (function(){
      try {
        if (localStorage.getItem('characterPanelOpen') === '1') {
          // Apply before first paint so sidebar toggle never flashes
          var apply = function(){ document.body && document.body.classList.add('character-panel-open'); };
          if (document.body) apply(); else document.addEventListener('DOMContentLoaded', apply, { once: true });
        }
      } catch(_){ /* ignore */ }
    })();
  </script>
  <div id="app-loading" class="loading-overlay" role="status" aria-live="polite">
    <div class="loading-overlay__content">
      <span class="loading-overlay__spinner" aria-hidden="true"></span>
      <span id="app-loading-message">Loading the grimoire...</span>
    </div>
  </div>
  <div id="app">
    <div id="sidebar">
      <div class="section">
        <h3>Game Setup</h3>
        <div>
          <label for="player-count">Player Count:</label>
          <input type="number" id="player-count" min="5" max="20" value="5">
        </div>
        <div id="mode-toggle" style="margin-top: 8px; display: flex; gap: 10px; align-items: center;">
          <span>I'm a:</span>
          <label><input type="radio" name="mode" id="mode-player" value="player" checked> Player</label>
          <label><input type="radio" name="mode" id="mode-storyteller" value="storyteller"> Storyteller</label>
        </div>
        <div style="margin-top: 8px; display:flex; flex-direction: column; gap:8px; align-items:stretch;">
          <button class="button" id="open-player-setup">Start Player Setup</button>
          <button class="button" id="reveal-selected-characters" style="display:none;">Reveal Selected Characters</button>
          <a class="button" id="open-rulebook" style="text-align:center;" href="https://drive.google.com/file/d/1kyOY-4PmSnQNoH3axyq1cEjVZ2T3kmlm/view" target="_blank" rel="noopener noreferrer">Rulebook</a>
          <button class="button" id="end-game">End Game</button>
          <button class="button" id="reveal-assignments">Reveal Characters</button>
          <button class="button" id="grimoire-lock-toggle" style="display:none;">Lock Grimoire</button>
        </div>
        <div style="display:flex; flex-direction: column; gap:8px; margin-top:8px;">
          <button class="button" id="reset-grimoire">Reset Grimoire</button>
          <button class="button" id="open-storyteller-message" style="display: none;">Storyteller Message</button>
        </div>
        <div id="game-status" class="status" aria-live="polite"></div>
      </div>

      <div class="section">
        <h3>Script Management</h3>
        <div class="script-buttons">
          <button class="button" id="load-tb">Trouble Brewing</button>
          <button class="button" id="load-bmr">Bad Moon Rising</button>
          <button class="button" id="load-sav">Sects &amp; Violets</button>
          <button class="button" id="load-all-chars">Load All Characters</button>
        </div>
        <div id="load-status" aria-live="polite"></div>
        <div style="margin-top: 15px;">
          <label for="script-file">Or Upload Custom Script:</label>
          <input type="file" id="script-file" accept=".json">
          <label for="script-text-input" style="display:block; margin-top:8px;">Or Paste Script JSON:</label>
          <textarea id="script-text-input" rows="6" style="width:100%; resize:vertical;" placeholder='Paste script JSON here'></textarea>
          <button class="button" id="load-script-text" style="margin-top:8px;">Load Pasted Script</button>
          <label for="script-url-input" style="display:block; margin-top:8px;">Or Load From Link:</label>
          <input type="url" id="script-url-input" placeholder="https://www.botcscripts.com/api/scripts/.../json/" style="width:100%;">
          <button class="button" id="load-script-url" style="margin-top:8px;">Load Script From URL</button>
          <p style="font-size:12px; opacity:0.8; margin-top:6px;">Tip: Use a shared link to auto-load a script on open.</p>
        </div>
        <div style="margin-top: 15px;">
          <h3>Script History</h3>
          <ul id="script-history-list" class="history-list"></ul>
        </div>
      </div>

      <div class="section">
        <h3>Background</h3>
        <div>
          <select id="background-select">
            <option value="dark">Dark (Plain)</option>
            <option value="red-gradient">Red Gradient</option>
            <option value="dark-purple">Dark Purple</option>
            <option value="wood">Wood Texture</option>
            <option value="cosmic">Cosmic Vortex</option>
          </select>
        </div>
      </div>
      <div class="section">
        <h3>Color Theme</h3>
        <div>
          <select id="theme-select">
            <option value="blue">Blue</option>
            <option value="purple">Purple</option>
          </select>
        </div>
      </div>
      <div class="section">
        <h3>Grimoire History</h3>
        <ul id="grimoire-history-list" class="history-list"></ul>
      </div>
      <div class="section">
        <h3>History Management</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
          <button class="button" id="export-history-btn">Export History</button>
          <button class="button" id="import-history-btn">Import History</button>
          <input type="file" id="import-history-file" accept=".json" style="display: none;">
        </div>
        <div id="import-status" aria-live="polite"></div>
      </div>
      <div class="section">
        <h3>Tutorial</h3>
        <div id="tutorial-sidebar-content">
          <p>Quick tour: set players, load a script, assign characters, add reminders.</p>
          <button class="button" id="start-tour">Start Tutorial</button>
        </div>
      </div>
      <div class="section">
        <a class="button" href="terms.html">Terms of Use</a>
      </div>
      <div class="section sidebar-version" aria-label="Application version" style="text-align:center; font-size:11px; opacity:.55; user-select:none;">
        <span>v</span><span id="app-version-value">?</span>
      </div>
    </div>
    <div id="sidebar-resizer" aria-label="Resize sidebar" role="separator"></div>

    <div id="grimoire">
      <button id="sidebar-toggle" class="button sidebar-toggle" aria-label="Toggle sidebar" aria-pressed="false">Close
        Sidebar</button>
  <button id="character-panel-toggle" class="button character-panel-toggle" aria-label="Toggle script panel" aria-pressed="false" data-testid="character-panel-toggle">Script</button>
      <button id="day-night-toggle" data-testid="day-night-toggle" class="button day-night-toggle"
        aria-label="Toggle day/night tracking" aria-pressed="false" title="Toggle day/night tracking">
        <i class="fas fa-moon"></i>
      </button>
      <button id="display-settings-toggle" data-testid="display-settings-toggle" class="button display-settings-toggle"
        aria-label="Adjust display settings" aria-pressed="false" title="Adjust display settings">
        <i class="fas fa-sliders-h"></i>
      </button>
      <div id="display-settings-panel" data-testid="display-settings-panel" class="display-settings-panel" aria-hidden="true">
        <h4>Display Settings</h4>
        <div class="display-settings-row">
          <label for="player-name-size-slider">Player name</label>
          <div class="slider-wrapper">
            <input type="range" id="player-name-size-slider" data-testid="player-name-slider" min="60" max="120" step="5" value="100">
            <span class="slider-marker" data-settings-marker="player-name" aria-hidden="true"></span>
          </div>
          <span class="display-settings-value" data-settings-value="player-name">100%</span>
        </div>
        <div class="display-settings-row">
          <label for="token-size-slider">Player token</label>
          <div class="slider-wrapper">
            <input type="range" id="token-size-slider" data-testid="token-size-slider" min="60" max="160" step="5" value="100">
            <span class="slider-marker" data-settings-marker="token" aria-hidden="true"></span>
          </div>
          <span class="display-settings-value" data-settings-value="token">100%</span>
        </div>
        <div class="display-settings-row">
          <label for="circle-size-slider">Grimoire circle</label>
          <div class="slider-wrapper">
            <input type="range" id="circle-size-slider" data-testid="circle-size-slider" min="60" max="160" step="5" value="100">
            <span class="slider-marker" data-settings-marker="circle" aria-hidden="true"></span>
          </div>
          <span class="display-settings-value" data-settings-value="circle">100%</span>
        </div>
      </div>
      <div class="sidebar-backdrop" id="sidebar-backdrop" aria-hidden="true"></div>
      <div id="center">
        <div id="player-circle-wrapper">
          <ul id="player-circle" class="circle"></ul>
          <div id="setup-info" aria-live="polite"></div>
        </div>
      </div>
      <div id="day-night-slider" data-testid="day-night-slider" class="day-night-slider">
        <div class="slider-container">
          <div id="phase-labels" data-testid="phase-labels" class="phase-labels"></div>
          <input type="range" min="0" max="0" value="0" class="phase-slider" id="phase-slider">
          <div id="current-phase" data-testid="current-phase" class="current-phase">N1</div>
          <button id="add-phase-button" data-testid="add-phase-button" class="add-phase-button"
            aria-label="Add next phase">+</button>
        </div>
      </div>
      <aside id="character-panel" class="character-panel" aria-label="Character panel" aria-hidden="true">
        <div class="character-panel-header">
          <h3>Script</h3>
          <button id="character-panel-close" class="panel-close" aria-label="Close character panel">&times;</button>
        </div>
        <button class="button character-panel-close-mobile" id="character-panel-close-mobile" aria-label="Close panel">
          <i class="fas fa-times"></i>
        </button>
        <div class="panel-controls">
          <label><input type="checkbox" id="include-travellers" data-testid="include-travellers-checkbox"> Include Travellers</label>
          <div class="night-order-controls">
            <label data-testid="night-order-sort-label">
              <input type="checkbox" id="night-order-sort" data-testid="night-order-sort-checkbox"> Show night order
            </label>
            <div class="night-phase-buttons" data-testid="night-phase-selector">
              <!-- Hidden radios retained for state/tests if needed -->
              <input type="radio" name="night-phase" id="first-night-btn" value="first-night" checked class="sr-only">
              <input type="radio" name="night-phase" id="other-nights-btn" value="other-nights" class="sr-only">
              <button type="button" id="night-phase-toggle" aria-live="polite" aria-label="Toggle night phase" data-testid="night-phase-toggle">First Night</button>
            </div>
          </div>
        </div>
        <div id="character-sheet" class="panel-body">
          <p>Load a script to see available characters.</p>
        </div>
      </aside>
    </div>
  </div>

  <div id="character-modal" class="modal">
    <div class="modal-content">
      <h3>Select Character for <span id="character-modal-player-name"></span></h3>
      <input type="text" id="character-search" placeholder="Search characters...">
      <div style="margin: 8px 0;">
        <label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="include-travellers-in-modal" data-testid="include-travellers-in-modal-checkbox" style="cursor: pointer;">
          <span>Include Travellers</span>
        </label>
      </div>
      <div id="hide-in-play-container" style="margin: 8px 0; display: none;">
        <label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="hide-in-play" style="cursor: pointer;">
          <span>Hide in-play characters</span>
        </label>
      </div>
      <div id="character-grid"></div>
    </div>
  </div>

  <div id="text-reminder-modal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="close-text-reminder-x" aria-label="Close reminder"><i class="fas fa-times"></i></button>
      <h3>Add/Edit Reminder</h3>
      <input type="text" id="reminder-text-input" placeholder="Enter reminder text...">
      <button class="button" id="save-reminder-btn" data-testid="save-text-reminder">Save</button>
    </div>
  </div>

  <div id="custom-reminder-edit-modal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="close-custom-reminder-edit" aria-label="Close custom reminder edit"><i class="fas fa-times"></i></button>
      <h3 id="custom-reminder-modal-title">Custom Reminder</h3>
      <div id="custom-reminder-text-input" class="message-text" contenteditable="true" spellcheck="false" role="textbox" aria-label="Custom reminder text"></div>
      <button class="button" id="save-custom-reminder-btn">Save</button>
    </div>
  </div>

  <div id="reminder-token-modal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="close-reminder-token-modal-x" aria-label="Close reminder token selection"><i class="fas fa-times"></i></button>
      <h3>Select Reminder Token for <span id="reminder-token-modal-player-name"></span></h3>
      <input type="text" id="reminder-token-search" placeholder="Search tokens or characters...">
      <div id="reminder-token-grid"></div>
    </div>
  </div>

  <div id="player-setup-panel" class="modal" style="display:none;">
    <div class="modal-content">
      <button class="modal-close" id="close-player-setup" aria-label="Close player setup"><i class="fas fa-times"></i></button>
      <h3>Player Setup (Storyteller)</h3>
      <div id="bag-count-warning" class="error" style="display:none;">Warning: Selected bag does not match player count configuration.</div>
      <div style="margin: 8px 0;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="include-travellers-in-bag" style="cursor: pointer;">
          <span>Include Travellers in Selection</span>
        </label>
      </div>
      <div style="margin: 8px 0; display:flex; gap:10px; align-items:stretch;">
        <button class="button" id="bag-shuffle">Shuffle Characters</button>
        <button class="button start-selection">Start Number Selection</button>
      </div>
      <div id="player-setup-counts" class="player-setup-counts" aria-live="polite" style="display:flex; flex-wrap:wrap; gap:12px; margin: 8px 0;">
        <div class="team-count" data-team="townsfolk" style="display:flex; align-items:center; gap:6px;">
          <span class="team-label" style="font-weight:600;">Townsfolk</span>
          <span class="team-count-value"><span class="selected-count">0</span>/<span class="required-count">0</span></span>
        </div>
        <div class="team-count" data-team="outsiders" style="display:flex; align-items:center; gap:6px;">
          <span class="team-label" style="font-weight:600;">Outsiders</span>
          <span class="team-count-value"><span class="selected-count">0</span>/<span class="required-count">0</span></span>
        </div>
        <div class="team-count" data-team="minions" style="display:flex; align-items:center; gap:6px;">
          <span class="team-label" style="font-weight:600;">Minions</span>
          <span class="team-count-value"><span class="selected-count">0</span>/<span class="required-count">0</span></span>
        </div>
        <div class="team-count" data-team="demons" style="display:flex; align-items:center; gap:6px;">
          <span class="team-label" style="font-weight:600;">Demons</span>
          <span class="team-count-value"><span class="selected-count">0</span>/<span class="required-count">0</span></span>
        </div>
        <div class="team-count" data-team="travellers" style="display:none; align-items:center; gap:6px;">
          <span class="team-label" style="font-weight:600;">Travellers</span>
          <span class="team-count-value"><span class="selected-count">0</span></span>
        </div>
      </div>
      <div id="player-setup-character-list"></div>
    </div>
  </div>

  <div id="number-picker-overlay" class="modal" style="display:none;">
    <div class="modal-content">
      <button class="modal-close" id="close-number-picker" aria-label="Close number picker"><i class="fas fa-times"></i></button>
      <h3>Pick a random number:</h3>
      <div id="number-picker-grid" style="display:grid; grid-template-columns: repeat(5, 1fr); gap:8px;"></div>
    </div>
  </div>

  <div id="player-reveal-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <button class="modal-close" id="close-player-reveal-modal" aria-label="Close player reveal"><i class="fas fa-times"></i></button>
      <h3>Your Character</h3>
      <div id="reveal-character-token" style="display: flex; justify-content: center; margin-bottom: 10px;"></div>
      <div id="reveal-ability" style="opacity: 0.9;"></div>
      <div style="margin-top: 12px; text-align: center;">
        <label for="reveal-name-input">Your name:</label>
        <input type="text" id="reveal-name-input" placeholder="Enter your name">
      </div>
    </div>
  </div>

  <div id="end-game-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <button class="modal-close" id="close-end-game-modal" aria-label="Close end game"><i class="fas fa-times"></i></button>
      <h3>Who won?</h3>
      <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
        <button class="button" id="good-wins-btn">Good Wins</button>
        <button class="button" id="evil-wins-btn">Evil Wins</button>
      </div>
    </div>
  </div>

  <div id="storyteller-message-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <button class="modal-close" id="close-storyteller-message" aria-label="Close storyteller message"><i class="fas fa-times"></i></button>
      <h3>Storyteller Messages</h3>
      <div id="storyteller-message-picker" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;"></div>
    </div>
  </div>

  <div id="storyteller-message-display" class="modal" style="display:none;">
    <div class="modal-content">
      <button class="modal-close" id="close-storyteller-message-display" aria-label="Close message"><i class="fas fa-times"></i></button>
      <div class="message-text"></div>
      <div id="storyteller-slots-display" style="display:flex; gap:16px; justify-content:center; align-items:center; margin-top:16px;"></div>
      <div class="bluffs-container" style="margin-top:16px;"></div>
    </div>
  </div>

  <!-- Ability tooltip for hover -->
  <div id="ability-tooltip" class="ability-tooltip"></div>

  <!-- Touch ability popup -->
  <div id="touch-ability-popup" class="touch-ability-popup"></div>

  <script type="module" src="script.js"></script>
</body>

</html>
