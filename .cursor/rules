name: Project Agent Rules
description: Enforce AGENTS.md workflow for background AI agents in Cursor.
version: 1

env:
  server_port: 8080
  test_port: 5173

steps:
  - id: start_local_server
    when: always
    run: npx --yes http-server -p {{server_port}} -c-1 . > /dev/null 2>&1 & echo $! > /tmp/http-server.pid

  - id: publish_local_port
    when: always
    run: |
      rm -f /workspace/.port /tmp/localtunnel.pid /tmp/localtunnel.log /tmp/localtunnel_watch.pid
      curl -fsSL https://loca.lt/mytunnelpassword > /workspace/.port
      echo "" >> /workspace/.port
      pkill -f 'localtunnel --port {{server_port}}' 2>/dev/null || true
      nohup sh -c 'npx --yes localtunnel --port {{server_port}} >> /tmp/localtunnel.log 2>&1' >/dev/null 2>&1 & echo $! > /tmp/localtunnel.pid
      nohup sh -c 'tail -F /tmp/localtunnel.log | grep -m1 -Eo "https?://[^[:space:]]+" >> /workspace/.port' >/dev/null 2>&1 & echo $! > /tmp/localtunnel_watch.pid
      # Wait until .port has 2 lines (IP + URL) or timeout (~20s)
      for i in $(seq 1 80); do
        if [ "$(wc -l < /workspace/.port)" -ge 2 ]; then
          break
        fi
        sleep 0.25
      done

  - id: run_tests
    when: pre-commit
    run: npx --yes http-server -p {{test_port}} -c- . > /dev/null 2>&1 & CYPRESS_BASE_URL=http://127.0.0.1:{{test_port}} npx --yes cypress run --config-file tests/cypress.config.js ; kill %1 || true

  - id: eslint_fix
    when: pre-commit
    run: npx eslint --fix

